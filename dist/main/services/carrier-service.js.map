{"version":3,"sources":["../../../src/main/services/carrier-service.ts"],"sourcesContent":["import type { doc_document, rfid_switch_record } from '@prisma/client'\nimport { getReportData } from './rfid-service'\nimport {\n  addMisPlacedDocument,\n  queryInPlaceDocumentCount,\n  queryMisplacedDocument,\n  queryMisplacedDocumentCount,\n  updateDocStatusByID,\n  updateMisPlaceDocument,\n} from '@/database/methods/document'\nimport prisma from '@/database'\nimport { generateCurrentTime } from '@/utils'\n\nasync function getAllCarrierData(): Promise<doc_document[]> {\n  const result = await prisma.doc_document.findMany()\n  return result\n}\n\nasync function getCarrierDataByCondition(condition: CarrierQueryProps): Promise<{\n  data: doc_document[]\n  total: number\n}> {\n  const where = {\n    cabinet_door_id: condition.cabinetId ? Number(condition.cabinetId) : undefined,\n    doc_name: {\n      contains: condition.title,\n    },\n    loan_status: condition.state ?? undefined,\n    binding_dept_id: condition.departmentId ? Number(condition.departmentId) : undefined,\n  }\n\n  if (condition.state === 2) {\n    const misPlaceDocuments = await queryMisplacedDocument()\n    const rfids = misPlaceDocuments.map(item => item.operation_id)\n    where.loan_status = 1\n    where.doc_rfid = { in: rfids }\n  }\n  else if (condition.state === 1) {\n    const misPlaceDocuments = await queryMisplacedDocument()\n    const rfids = misPlaceDocuments.map(item => item.operation_id)\n    where.loan_status = 1\n    where.doc_rfid = { notIn: rfids }\n  }\n\n  const result = await prisma.doc_document.findMany({\n    skip: (condition.page - 1) * condition.size,\n    take: condition.size,\n    where,\n  })\n\n  const count = await prisma.doc_document.count({\n    where,\n  })\n\n  return {\n    data: result,\n    total: count,\n  }\n}\n\nasync function getCarrierDataByCabinetId(cabinetId: number): Promise<doc_document[]> {\n  const result = await prisma.doc_document.findMany({\n    where: {\n      cabinet_door_id: cabinetId,\n    },\n  })\n\n  return result\n}\n\nasync function getInPlaceCarrierCount(cabinetId?: number) {\n  return await queryInPlaceDocumentCount(cabinetId)\n}\n\nasync function getMisPlaceCarriers(): Promise<rfid_switch_record[]> {\n  return await queryMisplacedDocument()\n}\n\nasync function updateCarrier(cabinetDoor: CabinetDoorProps, userId?: number) {\n  const TIDList = getReportData(cabinetDoor.antenna_address)\n  console.log(cabinetDoor.id, '柜门id')\n  console.log('🚀 ~ file: document-service.ts:94 ~ updateCarrier ~ TIDList:', TIDList)\n  console.log('🚀 ~ file: document-service.ts:94 ~ updateCarrier ~ TIDList.length:', TIDList.length)\n\n  const documents = await getAllCarrierData()\n\n  for (let i = 0; i < documents.length; i++) {\n    const doc = documents[i]\n\n    // 如果不是本柜门文件\n    if (doc.cabinet_door_id !== cabinetDoor.id) {\n      const isWarningDocument = (await queryMisplacedDocumentCount(cabinetDoor.id, doc.doc_rfid)) !== 0\n      if (isWarningDocument)\n        continue\n\n      const data: Partial<rfid_switch_record> = {\n        cabinet_door_id: cabinetDoor.id,\n        cabinet_id: cabinetDoor.cabinet_id,\n        content: `文件[${doc.doc_name}]错放`,\n        datetime: generateCurrentTime(),\n        operation_id: TIDList.includes(doc.doc_rfid) ? doc.doc_rfid : '0',\n        type: '1',\n        user_id: userId || null,\n      }\n      await addMisPlacedDocument(data)\n    }\n    else {\n      const isDocumentDetected = TIDList.includes(doc.doc_rfid)\n\n      // 归还\n      if (isDocumentDetected && doc.loan_status === 1)\n        await updateDocStatusByID(doc.doc_id, 0, userId)\n\n      // 借出\n      else if (!isDocumentDetected && doc.loan_status === 0)\n        await updateDocStatusByID(doc.doc_id, 1, userId)\n    }\n  }\n\n  const misPlaceDocuments = await getMisPlaceCarriers()\n  for (let i = 0; i < misPlaceDocuments.length; i++) {\n    const doc = misPlaceDocuments[i]\n    if (!TIDList.includes(doc.operation_id))\n      await updateMisPlaceDocument(doc.operation_id)\n  }\n}\n\nconst carrierService = {\n  name: 'carrier' as const,\n  fns: {\n    getAllCarrierData,\n    getCarrierDataByCondition,\n    getCarrierDataByCabinetId,\n    getInPlaceCarrierCount,\n    getMisPlaceCarriers,\n    updateCarrier,\n  },\n}\n\nexport default carrierService\n"],"names":["getAllCarrierData","result","prisma","doc_document","findMany","getCarrierDataByCondition","condition","where","misPlaceDocuments","rfids","count","cabinet_door_id","cabinetId","Number","undefined","doc_name","contains","title","loan_status","state","binding_dept_id","departmentId","queryMisplacedDocument","map","item","operation_id","doc_rfid","in","notIn","skip","page","size","take","data","total","getCarrierDataByCabinetId","getInPlaceCarrierCount","queryInPlaceDocumentCount","getMisPlaceCarriers","updateCarrier","cabinetDoor","userId","TIDList","documents","i","doc","isWarningDocument","isDocumentDetected","getReportData","antenna_address","console","log","id","length","queryMisplacedDocumentCount","cabinet_id","content","datetime","generateCurrentTime","includes","type","user_id","addMisPlacedDocument","updateDocStatusByID","doc_id","updateMisPlaceDocument","carrierService","name","fns"],"mappings":"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"}